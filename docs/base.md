## Команда /база
### Что делает?
#### При вызове без текста
Выводит случайное сообщение из беседы, занесённое в базу данных.
#### При вызове с текстом
Разбивает текст на ключевые слова, приводит их к начальной форме.
Ищет сообщение из беседы в базе данных, которое содержит больше всего данных ключевых
слов, и выводит ответ на него (если ответа нет, то просто следующее за ним сообщение).
### Как работает?
Задействовано 2 базы данных Redis.
- `db4` хранит сообщения в виде `hash` и соответствия `conversation_message_id`
порядковым номерам в виде `zset`, например:
```
127.0.0.1:6379[4]> hgetall 1:34662
1) "answers"
2) "50480 50485"
3) "text"
4) "хей, дружок пирожок"
```
- `1` - id беседы в БД (peer_id - 2000000000)
- `34662` - id сообщения в БД (порядковый номер)
- `50480 50485` - `conversation_message_id` сообщений-ответов
```
127.0.0.1:6379[4]> zrange 1 50480 50480 byscore withscores
1) "1:34663"
2) "50480"
```
- `1` - id беседы в БД (peer_id - 2000000000)
- `34663` - id сообщения в БД (порядковый номер)
- `50480` - `conversation_message_id` сообщения


- `db5` хранит ключевые слова и индексы (<id беседы>:<порядковый номер>) содержащих
их сообщений в виде `set`, например:
```
127.0.0.1:6379[5]> smembers "база"
   1) "1:138311"
   2) "1:128382"
   3) "1:144674"
   4) "1:182201"
   5) "1:96868"
   6) "1:229658"
   7) "1:191582"
   8) "1:135773"
   9) "1:102013"
  10) "1:177869"
  11) "1:259325"
  12) "1:202264"
  13) "1:157158"
  14) "1:103279"
  15) "1:213555"
  16) "1:192091"
  17) "1:83606"
  ...
```
- Каждому элементу этого `set` соответствует `hash` в `db4`.

Обе базы данных пополняются при поступлении новых сообщений в одной из отслеживаемых
бесед.
### Ссылки
Реализация поиска по ключевым словам: [base.py](../vk_specific/base.py),
[keyword_search.lua](../redis_scripts/keyword_search.lua)

Ежедневная очистка БД, чтобы на одну беседу приходилось не более N байт сообщений:
[daily_cleanup.lua](../redis_scripts/daily_cleanup.lua)